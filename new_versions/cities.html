<html>
<head>
	<title>Map Quiz: Cities</title>
</head>
<body bgcolor="#FFFFFF" marginheight="0" marginwidth="0" topmargin="0" leftmargin="0">

<center>
    <img src="cities.jpg" id="map" usemap="#img-map" border="0" style="z-index:0;">
	<map id="img-map" name="img-map"></map>
</center>

<div id="control-form"></div>
<center><font size="-1">Â© 2002 Lance Jenott (updated by Peter Verkinderen)</font></center>


<script language="Javascript">

	var arrayPos=0;
	var skipped = [];
	var found = [];
	var errors = [];

	var features = {
        'Agra': {id: 1, coords: "407,188,417,198"},
        'Aleppo': {id: 2, coords: "94,122,104,132"},
        'Baghdad': {id: 3, coords: "152,143,160,153"},
        'Basra': {id: 4, coords: "177,165,187,175"},
        'Beijing': {id: 5, coords: "712,93,722,103"},
        'Bukhara': {id: 6, coords: "299,91,309,101"},
        'Chang`an': {id: 7, coords: "657,135,667,145"},
        'Constantinople': {id: 8, coords: "22,80,30,92"},
        'Damascus': {id: 9, coords: "88,136,98,144"},
        'Delhi': {id: 10, coords: "403,175,413,185"},
        'Dunhuang': {id: 11, coords: "539,93,549,103"},
        'Guangzhou': {id: 12, coords: "683,221,693,231"},
        'Isfahan': {id: 13, coords: "199,145,209,155"},
        'Jerusalem': {id: 14, coords: "80,152,90,162"},
        'Kabul': {id: 15, coords: "351,131,361,141"},
        'Karakorum': {id: 16, coords: "614,33,624,43"},
        'Kashgar': {id: 17, coords: "396,97,408,108"},
        'Kesh': {id: 18, coords: "334,104,343,113"},
        'Khotan': {id: 19, coords: "419,112,429,122"},
        'Marv': {id: 20, coords: "278,108,288,118"},
        'Ormuz': {id: 21, coords: "239,196,249,206"},
        'Samarkand': {id: 22, coords: "326,92,336,102"},
        'Tabriz': {id: 23, coords: "163,104,173,114"},
        'Taxila': {id: 24, coords: "365,153,375,163"},
        'Urgench': {id: 25, coords: "267,76,277,86"}
	};
	let featureNamesShuffled = shuffleArray(Object.keys(features))

	document.onload = initialize();


	function initialize() {
		buildMap();
		buildForm();
	}


	function shuffleArray(array) {
		for (let i = array.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[array[i], array[j]] = [array[j], array[i]];
		}
		return array
	}

	function mapclick(clickedId) {
		let locationTofind = document.controls.locationTofind.value;
		let locationTofindID = features[locationTofind].id;

		if(clickedId==locationTofindID) {
			found.push(locationTofind);
			// remove the item from the skipped list, if it was there:
			skipped = skipped.filter((item) => item !== locationTofind);
			// move to the next quiz question:
			advance();
		} else {
			errors.push(locationTofind);
			buildForm();
			alert('Try Again');
		}
	}

	function skip() {
		let skippedTerm = document.controls.locationTofind.value;
		console.log("skipping", skippedTerm);
		if (!skipped.includes(skippedTerm)){
			skipped.push(skippedTerm);
		}
		console.log("You have now skipped "+ skipped.length + " places");
		
		advance()
	}

	function advance() {
		arrayPos++;
		if(arrayPos<featureNamesShuffled.length) {
			// If we are not at the end of our list of locations in the array 
			// then assign the current location to the "Find" box.
			buildForm()
			//document.controls.locationTofind.value = featureNamesShuffled[arrayPos]; 
			
		} else if (skipped.length > 0) {
			arrayPos = 0;
			featureNamesShuffled = shuffleArray(skipped);
			buildForm();
			alert('Finished; going back to the ' + skipped.length + ' skipped places!')
			skipped = [];
		} else 	if (arrayPos==featureNamesShuffled.length) {
			// If we have come to the end of our locations list 
			// (the array) then notify the user with "Finished!".
			buildForm() // to display the correct number of 
			alert('Finished!'); 
		}
	}

	function buildMap() {
		// build the image map:
		let mapStr = "";
		for (const [name, d] of Object.entries(features)) {
		  mapStr += `<area shape="rect" coords="${d.coords}" solution="${name}" href="javascript:mapclick(${d.id});" title="">\n`
		  // NB: using `href=` turns the cursor into a pointed finger,
		  // while using `onclick=` keeps the cursor in the same shape.
		}

		// insert the image map into the document:
		document.getElementById("img-map").innerHTML = mapStr;
	}

	function buildForm(){
		console.log("BUILD THE FORM");


		let controlStr = `
		<center>
		<form name="controls">
		<font face="helvetica" size=+2">Find</font>
		&nbsp;
		<input type="text" name="locationTofind" value="${featureNamesShuffled[arrayPos]}" size="15" onFocus="this.blur();">
		<br>
		<input type="button" value="     Skip     " onClick="skip();">
		<input type="button" value="     Quit     " onClick="window.close();">
		<input type="button" value="Start Over" onClick="location.reload();">
		</form>
		<p>You have correctly identified ${found.length} of ${Object.keys(features).length} places (skipped ${skipped.length}, errors ${errors.length})</p>
		</center>
		`
		document.getElementById("control-form").innerHTML = controlStr;
	}



</script>


</body></html>