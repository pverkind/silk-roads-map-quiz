<html>
<head>
	<title>Map Quiz: tarim</title>
</head>
<body bgcolor="#FFFFFF" marginheight="0" marginwidth="0" topmargin="0" leftmargin="0">

<center>
    <img src="tarim.jpg" id="map" usemap="#img-map" border="0" style="z-index:0;">
	<map id="img-map" name="img-map"></map>
</center>

<div id="control-form"></div>
<center><font size="-1">Â© 2002 Lance Jenott (updated by Peter Verkinderen)</font></center>


<script language="Javascript">

	var arrayPos=0;
	var skipped = [];
	var found = [];
	var errors = [];

	var features = {
                'Aksu': {id: 1, coords: "210,88,220,96", shape: "rect"},
        'Altun Shan Mnts.': {id: 2, coords: "453,161,450,173,588,154,588,137,503,150,453,161", shape: "poly"},
        'Anxi': {id: 3, coords: "625,88,635,98", shape: "rect"},
        'Charchlyk': {id: 4, coords: "378,171,388,180", shape: "rect"},
        'Cherchen': {id: 5, coords: "337,187,345,195", shape: "rect"},
        'Cherchen R.': {id: 6, coords: "372,160,383,162,363,174,348,182,340,181,349,173,372,160", shape: "poly"},
        'Dunhuang': {id: 7, coords: "589,106,599,114", shape: "rect"},
        'Hami': {id: 8, coords: "528,17,538,27", shape: "rect"},
        'Lk. Issyk Kul': {id: 9, coords: "113,33,114,37,131,42,155,38,163,31,164,26,113,33", shape: "poly"},
        'Karakorum Mnts.': {id: 10, coords: "9,217,6,257,143,261,78,209,9,217", shape: "poly"},
        'Khotan': {id: 11, coords: "196,202,204,210", shape: "rect"},
        'Khotan Darya R.': {id: 12, coords: "223,120,218,139,203,156,202,164,194,179,194,190,201,190,212,163,228,143,231,123,223,120", shape: "poly"},
        'Kashgar': {id: 13, coords: "99,135,107,143", shape: "rect"},
        'Koria': {id: 14, coords: "356,68,364,76", shape: "rect"},
        'Kucha': {id: 15, coords: "278,72,286,80", shape: "rect"},
        'Kun Lun Mnts.': {id: 16, coords: "110,192,114,219,161,226,199,239,267,245,267,226,233,224,197,218,181,208,110,192", shape: "poly"},
        'Lop Nor': {id: 17, coords: "448,111,448,131,463,131,459,110,448,111", shape: "poly"},
        'Loulan': {id: 18, coords: "451,97,459,105", shape: "rect"},
        'Miran': {id: 19, coords: "394,160,402,168", shape: "rect"},
        'Niya': {id: 20, coords: "270,203,283,216", shape: "rect"},
        'Taklamakan Desert': {id: 21, coords: "241,127,214,190,268,193,281,180,341,165,368,148,344,103,241,124", shape: "poly"},
        'Tashkorgan': {id: 22, coords: "62,182,72,190", shape: "rect"},
        'Tarim R.': {id: 23, coords: "233,105,281,88,304,84,328,79,366,80,366,88,318,88,287,96,236,113,235,103", shape: "poly"},
        'Tien Shan Mnts.': {id: 24, coords: "68,65,86,114,176,95,197,73,222,62,289,51,334,60,350,45,370,45,409,56,409,37,343,15,263,24,182,52,68,65", shape: "poly"},
        'Turfan': {id: 25, coords: "418,26,428,35", shape: "rect"},
        'Yangqi': {id: 26, coords: "366,56,376,66", shape: "rect"},
        'Yanguan': {id: 27, coords: "548,117,556,125", shape: "rect"},
        'Yarkand Darya R.': {id: 28, coords: "133,164,141,150,151,144,177,126,195,119,212,115,209,122,175,143,154,153,146,164,133,164", shape: "poly"},
        'Yumenguan': {id: 29, coords: "548,106,556,114", shape: "rect"},
	};
	let featureNamesShuffled = shuffleArray(Object.keys(features))

	document.onload = initialize();


	function initialize() {
		buildMap();
		buildForm();
	}


	function shuffleArray(array) {
		for (let i = array.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[array[i], array[j]] = [array[j], array[i]];
		}
		return array
	}

	function mapclick(clickedId) {
		let locationTofind = document.controls.locationTofind.value;
		let locationTofindID = features[locationTofind].id;

		if(clickedId==locationTofindID) {
			found.push(locationTofind);
			// remove the item from the skipped list, if it was there:
			skipped = skipped.filter((item) => item !== locationTofind);
			// move to the next quiz question:
			advance();
		} else {
			errors.push(locationTofind);
			buildForm();
			alert('Try Again');
		}
	}

	function skip() {
		let skippedTerm = document.controls.locationTofind.value;
		console.log("skipping", skippedTerm);
		if (!skipped.includes(skippedTerm)){
			skipped.push(skippedTerm);
		}
		console.log("You have now skipped "+ skipped.length + " places");
		
		advance()
	}

	function advance() {
		arrayPos++;
		if(arrayPos<featureNamesShuffled.length) {
			// If we are not at the end of our list of locations in the array 
			// then assign the current location to the "Find" box.
			buildForm()
			//document.controls.locationTofind.value = featureNamesShuffled[arrayPos]; 
			
		} else if (skipped.length > 0) {
			arrayPos = 0;
			featureNamesShuffled = shuffleArray(skipped);
			buildForm();
			alert('Finished; going back to the' + skipped.length + ' skipped places!')
			skipped = [];
		} else 	if (arrayPos==featureNamesShuffled.length) {
			// If we have come to the end of our locations list 
			// (the array) then notify the user with "Finished!".
			buildForm() // to display the correct number of 
			alert('Finished!'); 
		}
	}

	function buildMap() {
		// build the image map:
		let mapStr = "";
		for (const [name, d] of Object.entries(features)) {
		  mapStr += `<area shape="${d.shape}" coords="${d.coords}" solution="${name}" href="javascript:mapclick(${d.id});" title="">\n`
		  // NB: using `href=` turns the cursor into a pointed finger,
		  // while using `onclick=` keeps the cursor in the same shape.
		}

		// insert the image map into the document:
		document.getElementById("img-map").innerHTML = mapStr;
	}

	function buildForm(){
		console.log("BUILD THE FORM");


		let controlStr = `
		<center>
		<form name="controls">
		<font face="helvetica" size=+2">Find</font>
		&nbsp;
		<input type="text" name="locationTofind" value="${featureNamesShuffled[arrayPos]}" size="15" onFocus="this.blur();">
		<br>
		<input type="button" value="     Skip     " onClick="skip();">
		<input type="button" value="     Quit     " onClick="window.close();">
		<input type="button" value="Start Over" onClick="location.reload();">
		</form>
		<p>You have correctly identified ${found.length} of ${Object.keys(features).length} places (skipped ${skipped.length}, errors ${errors.length})</p>
		</center>
		`
		document.getElementById("control-form").innerHTML = controlStr;
	}



</script>


</body></html>